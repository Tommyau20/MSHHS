USE [master]
GO

-- ***** Create trigger to monitor creation of SQL logins - version 1.03 *****
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

IF EXISTS (SELECT * FROM sys.server_triggers WHERE name = 'trig_create_login')
	DROP TRIGGER trig_create_login
	ON ALL SERVER
GO

CREATE TRIGGER trig_create_login
ON ALL SERVER 
FOR CREATE_LOGIN
AS 
	BEGIN
	DECLARE @UserName VARCHAR(200),
            @servername VARCHAR(50), 
            @emailsubject VARCHAR(200),
	        @new_login VARCHAR(100),
	        @emailbody VARCHAR(1000),
			@operator VARCHAR(50) 
	SET @UserName = original_login()
	SET @servername = @@servername 	
	SET @new_login = CAST(EVENTDATA().query('/EVENT_INSTANCE/ObjectName/text()') AS VARCHAR(100)) 
	SET @emailsubject = 'MSSQL alert - create login notification for ' + @servername
	SET @emailbody = @UserName + ', has created the login "' + @new_login + '" on the server ' + @servername + CHAR(13) + CHAR(10)	
	EXEC msdb.dbo.sp_notify_operator @name = 'DBA',
									 @subject = @emailsubject,
									 @body = @emailbody
	END
GO

-- ****************** REMOVED FROM RBWH-STEM-VM1 24/11/2011 due to problems with superuser creating new logins ******************
-- ****************** REMOVED FROM RBWH-STEM-VM1 24/11/2011 due to problems with superuser creating new logins ******************
-- ****************** REMOVED FROM RBWH-STEM-VM1 24/11/2011 due to problems with superuser creating new logins ******************
-- ****************** REMOVED FROM RBWH-STEM-VM1 24/11/2011 due to problems with superuser creating new logins ******************
-- ****************** REMOVED FROM RBWH-STEM-VM1 24/11/2011 due to problems with superuser creating new logins ******************
-- ****************** REMOVED FROM RBWH-STEM-VM1 24/11/2011 due to problems with superuser creating new logins ******************

IF EXISTS (SELECT * FROM sys.server_triggers WHERE name = 'trig_create_login') AND @@servername = 'RBWH-STEM-VM1'
	BEGIN
	DROP TRIGGER trig_create_login
	ON ALL SERVER
	PRINT 'Trigger has been dropped given server being RBWH-STEM-VM1'
	END
ELSE
	BEGIN
	SELECT * FROM sys.server_triggers WHERE name = 'trig_create_login'
	END