USE [DBA]
GO

/****** Object:  StoredProcedure [dbo].[sp_InstanceCollector]    Script Date: 21/12/2018 3:25:48 PM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


----------------------------------------------------------------------------------------------------------
-- Object Type : Stored Procedure  
-- Object Name : sp_InstanceCollector
-- Description : Stored Procedure to collect instance related data
-- Author : David Shaw
-- Date : December 2019
-- Version : 1.01
----------------------------------------------------------------------------------------------------------

CREATE PROCEDURE [dbo].[sp_InstanceCollector]
AS
BEGIN
DELETE [DBA].[dbo].[Instance]
DECLARE @environment varchar(50)
DECLARE @cpu_count int
SELECT @environment = [Value] From [DBA].[dbo].[Parameters] WHERE [Parameter] = 'Environment'
SELECT @cpu_count = [cpu_count] from sys.dm_os_sys_info

INSERT INTO [DBA].[dbo].[Instance]
						   (ServerName,
							InstanceName,
							Environment,
							ProductVersion,
							Edition,
							ServicePack,
							CPU_count,
							IsClustered,
							IsHadrEnabled,
							DateCollected)
						VALUES (CONVERT(VARCHAR(50),(SERVERPROPERTY('ComputerNamePhysicalNetBIOS'))),
								CONVERT(VARCHAR(50),(SELECT ISNULL(SERVERPROPERTY('InstanceName'), 'default'))),
								@environment,
								CONVERT(VARCHAR(50),(SERVERPROPERTY('ProductVersion'))),				
								CONVERT(VARCHAR(50),(SERVERPROPERTY('Edition'))),
								CONVERT(VARCHAR(50),(SERVERPROPERTY('ProductLevel'))),
								@cpu_count,
								CONVERT(bit,(SERVERPROPERTY('IsClustered'))),
								CONVERT(bit,(SERVERPROPERTY('IsHadrEnabled'))),
								getdate())

UPDATE [DBA].[dbo].[Instance] SET [Version] = '7' WHERE [ProductVersion] LIKE '7.00%'
UPDATE [DBA].[dbo].[Instance] SET [Version] = '2000' WHERE [ProductVersion] LIKE '8.00%'
UPDATE [DBA].[dbo].[Instance] SET [Version] = '2005' WHERE [ProductVersion] LIKE '9.00%'
UPDATE [DBA].[dbo].[Instance] SET [Version] = '2005' WHERE [ProductVersion] LIKE '9.0.%'
UPDATE [DBA].[dbo].[Instance] SET [Version] = '2008' WHERE [ProductVersion] LIKE '10.0%'
UPDATE [DBA].[dbo].[Instance] SET [Version] = '2008R2' WHERE [ProductVersion] LIKE '10.5%'
UPDATE [DBA].[dbo].[Instance] SET [Version] = '2012' WHERE [ProductVersion] LIKE '11.%'	
UPDATE [DBA].[dbo].[Instance] SET [Version] = '2014' WHERE [ProductVersion] LIKE '12.%'
UPDATE [DBA].[dbo].[Instance] SET [Version] = '2016' WHERE [ProductVersion] LIKE '13.%'
UPDATE [DBA].[dbo].[Instance] SET [Version] = '2017' WHERE [ProductVersion] LIKE '14.%'

END
GO


