USE [DBA]
GO

/****** Object:  StoredProcedure [dbo].[sp_FCIcheck]    Script Date: 1/4/2019 1:25:05 PM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


----------------------------------------------------------------------------------------------------------
-- Object Type : Stored Procedure  
-- Object Name : sp_InstanceCollector
-- Description : Stored Procedure to check FCI nodes and their status
-- Author : David Shaw
-- Date : January 2019
-- Version : 0.01
----------------------------------------------------------------------------------------------------------

CREATE PROCEDURE [dbo].[sp_FCIcheck]
AS
BEGIN
IF SERVERPROPERTY('IsClustered') = 1
	BEGIN
	-- ***** DECLARE GLOBAL VARIABLES *****
	DECLARE @NodeName VARCHAR(100)
	DECLARE @subject_string varchar(100) -- used to build the email subject
	DECLARE @body_string varchar(MAX) -- used to build the email body
	DECLARE @environment varchar(50) -- used to capture the enviornment for this instance
	SET @body_string = ''
	SELECT @environment = [Value] FROM [DBA].[dbo].[Parameters] WHERE [Parameter] = 'Environment'

	-- ***** CREATE CURSOR OF THOSE DATABASES WITHOUT ANY BACKUP *****
	DECLARE db_cursor CURSOR FOR  
		SELECT [NodeName] FROM [master].[sys].[dm_os_cluster_nodes] WHERE [status_description] <> 'up'

	OPEN db_cursor   
	FETCH NEXT FROM db_cursor INTO @NodeName  

	WHILE @@FETCH_STATUS = 0   
	BEGIN  
		SET @body_string = @body_string + 'The FCI node ' + @NodeName + ' appears to be in a state other than UP and needs investigation.' + CHAR(10)
		FETCH NEXT FROM db_cursor INTO @NodeName  
	END 
	CLOSE db_cursor   
	DEALLOCATE db_cursor
	If @body_string <> '' 
		BEGIN
		SET @subject_string = 'MSSQL alert (' + @environment + ') - FCI node(s) status problem'
		EXEC msdb.dbo.sp_notify_operator @name = 'DBA',
										 @subject = @subject_string,
										 @body = @body_string
		END
	END
END
GO


